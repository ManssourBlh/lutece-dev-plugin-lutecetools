<div class="container-fluid">
  <div class="row">
    <div class="col-lg-12">
      <div class="well hero">
        <h1>#i18n{lutecetools.components.title}</h1>
        <br>
        <#if !components_list.complete>
        <h3>
            <img src="images/skin/plugins/lutecetools/fetching.gif" width="64" height="64" alt="animated fetching icon" /> &nbsp;
            Recherche des informations en cours ...
        </h3>

        <div class="progress">
            <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="${components_list.percentAvailable}" aria-valuemin="0" aria-valuemax="100" style="width: ${components_list.percentAvailable}%;">
            ${components_list.percentAvailable}%
            </div>
        </div>
        </#if>
        <form method="GET" action="jsp/site/Portal.jsp">
            <input type="hidden" name="page" value="components" />
            <div class="row">
                <div class="col-md-4">
                    #i18n{lutecetools.components.count} : <strong> ${components_list.listComponents?size} </strong>
                </div>
                <div class="col-md-3">
                    <input type="checkbox" name="github" <#if github_filter> checked </#if> /> Filtrer sur les projets GitHub
                </div>
                <div class="col-md-3">
                   <input type="checkbox" name="core"  <#if core_versions> checked </#if> /> Afficher les versions du core
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary btn-xs" type="submit" title="Refresh" name="action_refresh">
                        <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>
                    </button>
                    <button class="btn btn-danger btn-xs" type="submit" title="Clear cache" name="action_clearCache" >
                        <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                    </button>
                </div>
            </div>
            <div class="row">
            	<div class="col-md-12">
            		#i18n{lutecetools.components.countLines} : <strong> ${total_lines} </strong>
            	</div>
            </div>
        </form>
        <br /><br />
        <div class="row" style="text-align:center">
       		<div class="col-md-3">
            	<strong>Github</strong>
            </div>
            <div class="col-md-3">
            	<strong>Jira</strong>
            </div>
            <div class="col-md-3">
            	<strong>Readme</strong>
            </div>
            <div class="col-md-3">
            	<strong>Sonar - RCI</strong>
            </div>
       	</div>
        <div class="row" style="text-align:center">
            <div class="col-md-3">
            	<canvas id="pieChart1" width="250"></canvas>
            </div>
            <div class="col-md-3">
            	<canvas id="pieChart2" width="250"></canvas>
            </div>
            <div class="col-md-3">
            	<canvas id="pieChart3" width="250"></canvas>
            </div>
            <div class="col-md-3">
            	<canvas id="pieChart4" width="250"></canvas>
            </div>
        </div>
        <div class="table-responsive">
            <table id="components-table" class="table table-striped table-hover table-condensed tablesorter">
                <thead>
                    <tr>
                        <th>#i18n{lutecetools.components.labelComponent}</th>
                        <th colspan="4">GitHub</th>
                        <th colspan="2">#i18n{lutecetools.components.labelVersion}</th>
                        <th colspan="2">#i18n{lutecetools.components.labelParentPomVersion}</th>
                        <#if core_versions>
                            <th colspan="2">#i18n{lutecetools.components.labelCoreVersion}</th>
                        </#if>
                        <th>Sonar</th>
                        <th>&nbsp;</th>
                        <th colspan="3">Jira</th>
                        <th>#i18n{lutecetools.components.labelLinks}</th>
                    </tr>
                    <tr>
                        <th>&nbsp;</th>
                        <th class="small">status</th>
                        <th class="small">organization</th>
                        <th class="small">branches</th>
                        <th class="small">readme</th>
                        <th class="small">Snapshot</th>
                        <th class="small">Release</th>
                        <th class="small">Snapshot</th>
                        <th class="small">Release</th>
                        <#if core_versions>
                        <th class="small">Snapshot</th>
                        <th class="small">Release</th>
                        </#if>
                        <th class="small">Lignes de code</th>
                        <th class="small">RCI</th>
                        <th class="small">Status</th>
                        <th class="small" colspan="2">Unreleased version</th>
                        <th>&nbsp;</th>
                    </tr>
                </thead>
                <tboby>
                    <#assign githubOk = 0 />
                    <#assign jiraOk = 0 />
                    <#assign readmeOk = 0 />
                    <#assign githubWarning = 0 />
                    <#assign jiraWarning = 0 />
                    <#assign githubDanger = 0 />
                    <#assign jiraDanger = 0 />
                    <#assign readmeDanger = 0 />
                    <#assign RCIOk = 0 />
                    <#assign RCIWarning = 0 />
                    <#assign RCIDanger = 0 />
                    <#assign nbLinesTotal = 0 />
                    <#list components_list.listComponents as component>
                    <tr>
                        <td class="small">${component.artifactId}</td>
                        <td>
                            <#if component.gitHubStatus gt 0 && component.gitHubStatus lt 3>
                                <img src="images/skin/plugins/lutecetools/github-red.png" title="${component.gitHubErrors}" alt="GitHub status RED" width="24" height="24">
                            	<#assign githubDanger = githubDanger + 1>
                            </#if>
                            <#if component.gitHubStatus == 3 >
                                <img src="images/skin/plugins/lutecetools/github-orange.png" title="${component.gitHubErrors}" alt="GitHub status ORANGE" width="24" height="24">
                            	<#assign githubWarning = githubWarning + 1>
                            </#if>
                            <#if component.gitHubStatus == 4 >
                                <img src="images/skin/plugins/lutecetools/github-green.png" title="${component.gitHubErrors}" alt="GitHub status GREEN" width="24" height="24">
                                <#assign githubOk = githubOk + 1>
                            </#if>
                        </td>
                        <td class="small">${component.gitHubOwner!""}</td>
                        <td class="small">
                            <#if component.branchesList??>
                               <#list component.branchesList as branch>
                               ${branch}<br>
                               </#list>
                            </#if>
                        </td>
                        <td>
                            <#if !component.gitHubReadme && component.gitHubStatus gt 0>
                                <img src="images/skin/plugins/lutecetools/readme-red.png" title="Readme file missing" width="24" height="24" />
                            	<#assign readmeDanger = readmeDanger +1 />
                            </#if>
                            <#if component.gitHubReadme && component.gitHubStatus gt 0>
                                <img src="images/skin/plugins/lutecetools/readme-green.png" title="Readme file available" width="24" height="24" />
                                <#assign readmeOk = readmeOk +1 />
                            </#if>
                        </td>
                        <td class="small">
                            <#if component.snapshotScmUrl?contains("git")>
                            <a href="${component.snapshotScmUrl}">
                                <img src="images/skin/plugins/lutecetools/github.png" alt="GitHub logo" width="24" height="24">
                            </a>
                            </#if>
                            <#if component.snapshotScmUrl?contains("svn")>
                            <a href="${component.snapshotScmUrl}">
                                <img src="images/skin/plugins/lutecetools/subversion.png" alt="GitHub logo" width="24" height="24">
                            </a>
                            </#if>
                            ${component.snapshotVersion!"Not found"}
                        </td>
                        <td class="small">
                            <#if component.scmUrl?contains("git")>
                            <a href="${component.scmUrl}">
                                <img src="images/skin/plugins/lutecetools/github.png" alt="GitHub logo" width="24" height="24">
                            </a>
                            </#if>
                            <#if component.scmUrl?contains("svn")>
                            <a href="${component.scmUrl}" >
                                <img src="images/skin/plugins/lutecetools/subversion.png" alt="GitHub logo" width="24" height="24">
                            </a>
                            </#if>
                            ${component.version}
                        </td>
                        <td class="small">${component.snapshotParentPomVersion!"Not found"}</td>
                        <td class="small">${component.parentPomVersion!"Not found"}</td>
                        <#if core_versions>
                        <td class="small">${component.snapshotCoreVersion!"Not found"}</td>
                        <td class="small">${component.coreVersion!"Not found"}</td>
                        </#if>
                        <td class="small">${component.sonarNbLines!"Not found"}</td>
                        <td class="small">
                        	<#attempt>
	                        	<#assign nb = "${component.sonarRCI}"?replace("%", "")?number>
	                        	<#if nb gte "${rci_color_success}"?number>
	                        		<span class="glyphicon glyphicon-ok-sign" style="color:#00b300;font-size:2em;"></span>
	                        		<#assign RCIOk = RCIOk + 1>
	                        	<#elseif nb gte "${rci_color_warning}"?number && nb lt "${rci_color_success}"?number>
	                        		<span class="glyphicon glyphicon-exclamation-sign" style="color:orange;font-size:2em;"></span>
	                        		<#assign RCIWarning = RCIWarning + 1>
	                        	<#else>
	                        		<span class="glyphicon glyphicon-remove-sign" style="color:red;font-size:2em;"></span>
	                        		<#assign RCIDanger = RCIDanger + 1>
	                        	</#if>
	                        	${component.sonarRCI}
							<#recover>
                        		Not found
                        	</#attempt>
                        </td>
                        <td>
                            <#if component.jiraStatus == 0 >
                                <img src="images/skin/plugins/lutecetools/jira-red.png" title="${component.jiraErrors}" alt="Jira status RED" width="24" height="24">
                            	<#assign jiraDanger = jiraDanger + 1>
                            </#if>
                            <#if component.jiraStatus == 1 >
                                <img src="images/skin/plugins/lutecetools/jira-orange.png" title="${component.jiraErrors}" alt="Jira status ORANGE" width="24" height="24">
                            	<#assign jiraWarning = jiraWarning + 1>
                            </#if>
                            <#if component.jiraStatus == 2 >
                                <img src="images/skin/plugins/lutecetools/jira-green.png" title="${component.jiraErrors}" alt="Jira status GREEN" width="24" height="24">
                                <#assign jiraOk = jiraOk + 1>
                            </#if>
                        </td>
                        <td class="small">
                            ${component.jiraLastUnreleasedVersion!"Not found"}
                        </td>
                        <td>
                            <#assign fixed = component.jiraIssuesCount - component.jiraUnresolvedIssuesCount />
                            <#assign unresolved = component.jiraUnresolvedIssuesCount />
                            <a href="https://dev.lutece.paris.fr/jira/browse/${component.jiraKey!''}#selectedTab=com.atlassian.jira.plugin.system.project%3Aroadmap-panel" >
                                <span class="label label-success"> ${fixed}</span>
                                <#if unresolved == 0>
                                    <span class="label label-success"> ${unresolved}</span>
                                <#else>
                                    <span class="label label-danger"> ${unresolved}</span>
                                </#if>
                            </a>
                            <#if fixed gt 0 && unresolved == 0>
                            <a href="https://dev.lutece.paris.fr/site-release/">
                                <img src="images/skin/plugins/lutecetools/release.png" title="Release" alt="release" width="24" height="24">
                            </a>
                            </#if>
                        </td>
                        <td>
                            <a href="https://dev.lutece.paris.fr/jira/browse/${component.jiraKey!''}" title="JIRA">
                                <img src="images/skin/plugins/lutecetools/jira.png" alt="Jira logo" width="24" height="24"/>
                            </a>
                            <a href="http://dev.lutece.paris.fr/plugins/${component.artifactId}/index.html" title="English" class="btn btn-default btn-xs">en</a>
                            <a href="http://dev.lutece.paris.fr/plugins/${component.artifactId}/fr/index.html" title="French" class="btn btn-default btn-xs">&nbsp;fr&nbsp;</a>
                            <a href="http://dev.lutece.paris.fr/maven_repository/fr/paris/lutece/plugins/${component.artifactId}" title="Maven repository" class="btn btn-default btn-xs">
                                <span class="glyphicon glyphicon-folder-open"></span>
                            </a>
                        </td>
                    </tr>
                    </#list>
                    <div class="row"  style="text-align:center;">
            			<div class="col-md-3">
                    		<img src="images/skin/plugins/lutecetools/github-green.png" alt="GitHub status GREEN" width="20" height="20">
                    		<span class="badge"> ${githubOk} </span> &nbsp;
                    		<img src="images/skin/plugins/lutecetools/github-orange.png" alt="GitHub status ORANGE" width="20" height="20">
                    		<span class="badge"> ${githubWarning} </span> &nbsp;
                    		<img src="images/skin/plugins/lutecetools/github-red.png" alt="GitHub status RED" width="20" height="20">
                    		<span class="badge"> ${githubDanger} </span> &nbsp;
                    	</div>
                    	<div class="col-md-3">
		                    <img src="images/skin/plugins/lutecetools/jira-green.png" alt="Jira status GREEN" width="20" height="20">
		                    <span class="badge"> ${jiraOk} </span> &nbsp;
		                    <img src="images/skin/plugins/lutecetools/jira-orange.png" alt="Jira status ORANGE" width="20" height="20">
		                    <span class="badge"> ${jiraWarning} </span> &nbsp;
		                    <img src="images/skin/plugins/lutecetools/jira-red.png" alt="Jira status RED" width="20" height="20">
		                    <span class="badge"> ${jiraDanger} </span> &nbsp;
		                </div>
		                <div class="col-md-3">
		                    <img src="images/skin/plugins/lutecetools/readme-green.png" alt="Readme status GREEN" width="20" height="20">
		                    <span class="badge"> ${readmeOk} </span> &nbsp;
		                    <img src="images/skin/plugins/lutecetools/readme-red.png" alt="Readme status RED" width="20" height="20">
		                    <span class="badge"> ${readmeDanger} </span> &nbsp;
		                </div>
		                <div class="col-md-3">
		                    <span class="glyphicon glyphicon-ok-sign" style="color:#00b300;font-size:1.1em;"></span>
		                    <span class="badge"> ${RCIOk} </span> &nbsp;
		                    <span class="glyphicon glyphicon-exclamation-sign" style="color:orange;"></span>
		                    <span class="badge"> ${RCIWarning} </span> &nbsp;
		                   	<span class="glyphicon glyphicon-remove-sign" style="color:red;"></span>
		                    <span class="badge"> ${RCIDanger} </span> &nbsp;
		                </div>
		            </div>
		            <br /><br />
                </tboby>
            </table>
        </div>
      </div>
    </div>
  </div>
  <div class="form-group" >
      <textarea  class="form-control">${logs}</textarea>
  </div>
  <input type="hidden" id="valGithubGreen" value="${githubOk}">
  <input type="hidden" id="valGithubOrange" value="${githubWarning}">
  <input type="hidden" id="valGithubRed" value="${githubDanger}">
  <input type="hidden" id="valJiraGreen" value="${jiraOk}">
  <input type="hidden" id="valJiraOrange" value="${jiraWarning}">
  <input type="hidden" id="valJiraRed" value="${jiraDanger}">
  <input type="hidden" id="valReadmeGreen" value="${readmeOk}">
  <input type="hidden" id="valReadmeRed" value="${readmeDanger}">
  <input type="hidden" id="valRCIGreen" value="${RCIOk}">
  <input type="hidden" id="valRCIOrange" value="${RCIWarning}">
  <input type="hidden" id="valRCIRed" value="${RCIDanger}">
</div>
<script>
$(document).ready(function(){
  // Refresh the page every 30s
  var time = new Date().getTime();
  $(document.body).bind("mousemove keypress", function(e) {
    time = new Date().getTime();
  });

  function refresh() {
    if(new Date().getTime() - time >= 30000 && ${components_list.percentAvailable} < 100)
      window.location.reload(true);
    else
      setTimeout(refresh, 10000);
  }
  setTimeout(refresh, 10000);
  $("#components-table").tablesorter();
  }
);
</script>
